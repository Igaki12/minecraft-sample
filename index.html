<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>2D Craft Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #333;
            color: white;
            font-family: sans-serif;
        }
        #game-container {
            border: 2px solid white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        canvas {
            background-color: #87CEEB; /* 空の色 */
            display: block;
        }
        #instructions {
            padding: 10px;
            background-color: #444;
            width: 800px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="instructions">
            <strong>操作方法:</strong> [A]キー: 左移動 | [D]キー: 右移動 | [スペース]キー: ジャンプ | [左クリック]: 破壊 | [右クリック]: 設置
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- ゲーム設定 ---
        const TILE_SIZE = 32;
        const MAP_COLS = Math.floor(canvas.width / TILE_SIZE);
        const MAP_ROWS = Math.floor(canvas.height / TILE_SIZE);

        const GRAVITY = 0.5;
        const JUMP_POWER = -10;
        const MOVE_SPEED = 4;

        // --- ブロックの種類 ---
        const BLOCKS = {
            AIR: 0,
            GRASS: 1,
            DIRT: 2,
            STONE: 3,
        };

        const BLOCK_COLORS = {
            [BLOCKS.GRASS]: '#228B22',
            [BLOCKS.DIRT]: '#8B4513',
            [BLOCKS.STONE]: '#808080',
        };

        // --- プレイヤー ---
        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            width: TILE_SIZE * 0.8,
            height: TILE_SIZE * 1.8,
            velocityX: 0,
            velocityY: 0,
            onGround: false,
            color: '#FF0000'
        };

        // --- ワールド（マップ） ---
        let world = [];

        function generateWorld() {
            for (let y = 0; y < MAP_ROWS; y++) {
                world[y] = [];
                for (let x = 0; x < MAP_COLS; x++) {
                    if (y < 10) {
                        world[y][x] = BLOCKS.AIR;
                    } else if (y === 10) {
                        world[y][x] = BLOCKS.GRASS;
                    } else if (y > 10 && y < 14) {
                        world[y][x] = BLOCKS.DIRT;
                    } else {
                        world[y][x] = BLOCKS.STONE;
                    }
                }
            }
        }

        // --- 入力処理 ---
        const keys = {};
        window.addEventListener('keydown', (e) => { keys[e.code] = true; });
        window.addEventListener('keyup', (e) => { keys[e.code] = false; });

        canvas.addEventListener('contextmenu', (e) => e.preventDefault()); // 右クリックメニューを無効化

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const tileX = Math.floor(mouseX / TILE_SIZE);
            const tileY = Math.floor(mouseY / TILE_SIZE);

            if (tileX >= 0 && tileX < MAP_COLS && tileY >= 0 && tileY < MAP_ROWS) {
                // 左クリックで破壊
                if (e.button === 0) {
                    if (world[tileY][tileX] !== BLOCKS.AIR) {
                        world[tileY][tileX] = BLOCKS.AIR;
                    }
                }
                // 右クリックで設置 (ここでは石を設置)
                if (e.button === 2) {
                    if (world[tileY][tileX] === BLOCKS.AIR) {
                         // プレイヤーと重なっていないかチェック
                        const playerTileX = Math.floor(player.x / TILE_SIZE);
                        const playerTileY = Math.floor(player.y / TILE_SIZE);
                        const playerTileY2 = Math.floor((player.y + player.height) / TILE_SIZE);

                        if (!(tileX === playerTileX && (tileY === playerTileY || tileY === playerTileY2))) {
                            world[tileY][tileX] = BLOCKS.STONE;
                        }
                    }
                }
            }
        });


        // --- ゲームループ ---
        function update() {
            // プレイヤーの移動処理
            player.velocityX = 0;
            if (keys['KeyA']) {
                player.velocityX = -MOVE_SPEED;
            }
            if (keys['KeyD']) {
                player.velocityX = MOVE_SPEED;
            }

            // ジャンプ処理
            if (keys['Space'] && player.onGround) {
                player.velocityY = JUMP_POWER;
                player.onGround = false;
            }

            // 物理演算
            // --- Y軸移動 ---
            player.velocityY += GRAVITY;
            player.y += player.velocityY;

            // Y軸当たり判定
            player.onGround = false;
            const playerTileLeft = Math.floor(player.x / TILE_SIZE);
            const playerTileRight = Math.floor((player.x + player.width) / TILE_SIZE);
            const playerTileTop = Math.floor(player.y / TILE_SIZE);
            const playerTileBottom = Math.floor((player.y + player.height) / TILE_SIZE);

            for (let y = playerTileTop; y <= playerTileBottom; y++) {
                for (let x = playerTileLeft; x <= playerTileRight; x++) {
                    if (x >= 0 && x < MAP_COLS && y >= 0 && y < MAP_ROWS && world[y][x] !== BLOCKS.AIR) {
                        const tileTop = y * TILE_SIZE;
                        const tileBottom = tileTop + TILE_SIZE;
                        // Y軸方向の衝突
                        if (player.y + player.height > tileTop && player.y < tileBottom) {
                            // 下方向の衝突（着地）
                            if (player.velocityY > 0) {
                                player.y = tileTop - player.height;
                                player.velocityY = 0;
                                player.onGround = true;
                            }
                            // 上方向の衝突（頭をぶつける）
                            else if (player.velocityY < 0) {
                                player.y = tileBottom;
                                player.velocityY = 0;
                            }
                        }
                    }
                }
            }

            // --- X軸移動 ---
            player.x += player.velocityX;

            // X軸当たり判定
            const nextPlayerTileLeft = Math.floor(player.x / TILE_SIZE);
            const nextPlayerTileRight = Math.floor((player.x + player.width) / TILE_SIZE);
            const playerTileTopX = Math.floor(player.y / TILE_SIZE);
            const playerTileBottomX = Math.floor((player.y + player.height) / TILE_SIZE);

            for (let y = playerTileTopX; y <= playerTileBottomX; y++) {
                for (let x = nextPlayerTileLeft; x <= nextPlayerTileRight; x++) {
                    if (x >= 0 && x < MAP_COLS && y >= 0 && y < MAP_ROWS && world[y][x] !== BLOCKS.AIR) {
                        const tileLeft = x * TILE_SIZE;
                        const tileRight = tileLeft + TILE_SIZE;
                        // 右方向の衝突
                        if(player.velocityX > 0) {
                            player.x = tileLeft - player.width;
                        } 
                        // 左方向の衝突
                        else if (player.velocityX < 0) {
                            player.x = tileRight;
                        }
                    }
                }
            }

            // 画面外に出ないようにする
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
        }

        function draw() {
            // 画面をクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ワールドを描画
            for (let y = 0; y < MAP_ROWS; y++) {
                for (let x = 0; x < MAP_COLS; x++) {
                    const blockType = world[y][x];
                    if (blockType !== BLOCKS.AIR) {
                        ctx.fillStyle = BLOCK_COLORS[blockType];
                        ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = '#000'; // ブロックの境界線
                        ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
            
            // マウスカーソルの位置に選択枠を描画
            const rect = canvas.getBoundingClientRect();
            canvas.onmousemove = function(e) {
                window.mouseX = e.clientX - rect.left;
                window.mouseY = e.clientY - rect.top;
            };
            if(window.mouseX !== undefined){
                const tileX = Math.floor(window.mouseX / TILE_SIZE);
                const tileY = Math.floor(window.mouseY / TILE_SIZE);
                ctx.strokeStyle = '#FFFF00';
                ctx.lineWidth = 2;
                ctx.strokeRect(tileX * TILE_SIZE, tileY * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                ctx.lineWidth = 1; // 他の描画のために太さを戻す
            }


            // プレイヤーを描画
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // ゲーム開始
        generateWorld();
        gameLoop();
    </script>
</body>
</html>